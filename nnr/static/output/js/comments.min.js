let addCommentForm=document.getElementById("addCommentForm");async function submitComment(e){let t={text:e.text.value,recipe:e.recipe.value,user:e.user.value};fetch(e.action,{method:"post",headers:{"Content-Type":"application/json","X-CSRFToken":e.csrfmiddlewaretoken.value,Accept:"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify(t)}).then((e=>e.json())).then((t=>{if(t.error){let n=createErrorDiv(t.error);e.before(n)}else{e.text.value="";let n=createComment(t.comment),d=document.getElementById("comment-list");d.insertBefore(n,d.children[0])}}))}function createErrorDiv(e){return createAlert(e,["alert-danger"])}function createComment(e){let t=document.createElement("div");t.id=e.id,t.classList.add("comment");let n=createCommentHeader(e);n.classList.add("comment-header"),t.appendChild(n);let d=document.createElement("div");d.classList.add("comment-body"),d.innerHTML=e.html,t.appendChild(d);let o=editModal(e);t.appendChild(o);let a=deleteModal(e.id);return t.appendChild(a),t}function createCommentHeader(e){let t=document.createElement("div");if(t.classList.add("text-muted","comment-header"),userSpan=document.createElement("span"),userSpan.textContent=e.user.username,userSpan.classList.add("comment-user"),t.appendChild(userSpan),tsSpan=document.createElement("span"),tsSpan.classList.add("comment-ts"),tsSpan.textContent=e.timestamp,t.appendChild(tsSpan),Number(document.querySelector('meta[name="user_id"]').content)===Number(e.user.id)){let n=document.createElement("div");n.classList.add("dropdown","float-right","comment-control"),dropdownButton=document.createElement("button"),dropdownButton.classList.add("btn","btn-outline-secondary","btn-sm","comment-dropdown"),dropdownButton.setAttribute("type","button"),dropdownButton.innerHTML="&#8901;&#8901;&#8901;";let d=`${e.id}-dropdown`;dropdownButton.id=d,dropdownButton.setAttribute("data-toggle","dropdown"),dropdownButton.setAttribute("aria-haspopup","true"),dropdownButton.setAttribute("aria-expanded","false"),n.appendChild(dropdownButton);let o=document.createElement("div");o.classList.add("dropdown-menu"),o.setAttribute("aria-labelledby",d),n.appendChild(o);let a=document.createElement("button");a.classList.add("dropdown-item"),a.setAttribute("data-toggle","modal"),a.setAttribute("data-target",`#edit-${e.id}-modal`),a.textContent="Edit",o.appendChild(a);let l=document.createElement("button");l.classList.add("dropdown-item"),l.setAttribute("data-toggle","modal"),l.setAttribute("data-target",`#delete-${e.id}-modal`),l.textContent="Delete",o.appendChild(l),t.appendChild(n)}return t}function editModal(e){let t=document.createElement("form");t.action="/comments/edit/",t.method="post",t.id=`edit-${e.id}`,t.classList.add("comment-form"),t.addEventListener("submit",(function(e){e.preventDefault(),editComment(t)}));let n=document.createElement("input");n.type="hidden",n.value=e.id,n.name="id",t.appendChild(n);let d=document.createElement("textarea");d.value=e.text,d.classList.add("textarea","form-control"),d.setAttribute("cols",40),d.setAttribute("rows",5),d.setAttribute("required",""),d.name="text";let o=document.createElement("div");o.classList.add("form-group"),o.appendChild(d),t.appendChild(o);let a=document.createElement("button");a.classList.add("btn","btn-secondary"),a.setAttribute("data-dismiss","modal"),a.textContent="Cancel";let l=document.createElement("input");l.type="submit",l.value="Submit",l.classList.add("btn","btn-primary");let i=document.createElement("div");return i.classList.add("form-actions"),i.appendChild(a),i.appendChild(l),t.appendChild(i),modal=Modal(`edit-${e.id}-modal`,"Edit Comment",t),modal}function deleteModal(e){let t=document.createElement("p");t.textContent="Comment will be deleted. Are you sure?";let n=document.createElement("div");n.appendChild(t);let d=document.createElement("form");d.id=`delete-${e}`,d.action="/comments/delete/",d.method="post",d.addEventListener("submit",(function(e){e.preventDefault(),deleteComment(d)}));let o=document.createElement("input");o.name="id",o.value=e,o.type="hidden",d.appendChild(o);let a=document.createElement("div");a.classList.add("form-actions"),d.appendChild(a);let l=document.createElement("button");l.textContent="No",l.setAttribute("data-dismiss","modal"),l.classList.add("btn","btn-secondary"),a.appendChild(l);let i=document.createElement("input");return i.textContent="Yes",i.type="submit",i.value="Yes",i.classList.add("btn","btn-danger"),a.appendChild(i),n.appendChild(d),Modal(`delete-${e}-modal`,"Delete Comment",n)}function Modal(e,t,n,d=null){let o=document.createElement("div");o.id=e,o.classList.add("modal"),o.setAttribute("tabindex","-1"),o.setAttribute("role","dialog");let a=`${e}-title`;o.setAttribute("aria-labelledby",a),o.setAttribute("aria-hidden","true");let l=document.createElement("div");l.classList.add("modal-dialog","modal-dialog-centered"),l.setAttribute("role","document"),o.appendChild(l);let i=document.createElement("div");i.classList.add("modal-content"),l.appendChild(i);let r=document.createElement("div");r.classList.add("modal-header");let m=document.createElement("h5");m.classList.add("modal-title"),m.textContent=t,r.appendChild(m),r.appendChild(closeModal()),i.appendChild(r);let s=document.createElement("div");if(s.classList.add("modal-body"),s.appendChild(n),i.appendChild(s),d){let e=document.createElement("div");e.classList.add("modal-footer"),e.appendChild(d),i.appendChild(e)}return o}function closeModal(){let e=document.createElement("button");e.setAttribute("type","button"),e.classList.add("close"),e.setAttribute("data-dismiss","modal"),e.setAttribute("aria-label","Close");let t=document.createElement("span");return t.setAttribute("aria-hidden","true"),t.innerHTML="&times;",e.appendChild(t),e}async function deleteComment(e){let t={id:e.id.value},n=document.querySelector('#comment-list input[name="csrfmiddlewaretoken"]').value;fetch(e.action,{method:"post",headers:{"Content-Type":"application/json","X-CSRFToken":n,Accept:"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify(t)}).then((e=>e.json())).then((n=>{let d=document.getElementById(t.id);if(document.querySelector(`#delete-${e.id.value}-modal button.close`).click(),n.error)ed=createErrorDiv(n.error),d.before(ed);else{let e=createAlert("Comment Deleted.",["alert-success"]);d.before(e),d.remove()}}))}async function editComment(e){let t={id:e.id.value,text:e.text.value},n=document.querySelector('#comment-list input[name="csrfmiddlewaretoken"]').value;fetch(e.action,{method:"post",headers:{"Content-Type":"application/json","X-CSRFToken":n,Accept:"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify(t)}).then((e=>e.json())).then((t=>{if(t.error)ed=createErrorDiv(response.error.message),e.before(ed);else{document.querySelector(`#edit-${e.id.value}-modal button.close`).click(),updateComment(t.comment)}}))}async function loadComments(e=null,t=25){let n=`/comments/list/?recipe_id=${document.querySelector('meta[name="recipe_id"]').content}&max_comments=${t}`;e&&(n+=`&start_from=${e}`),fetch(n,{method:"get",headers:{"Content-Type":"application/json",Accept:"application/json","X-Requested-With":"XMLHttpRequest"}}).then((e=>e.json())).then((e=>{let t=document.getElementById("comment-list"),n=document.getElementById("loadMoreButton");if(n&&n.remove(),e.error){let e=createErrorDiv(response.error);t.appendChild(e)}else for(let n=0;n<e.comment_list.length;n++){let d=createComment(e.comment_list[n]);if(t.appendChild(d),n===e.comment_list.length-1&&e.has_more){let e=loadMoreButton(d);t.appendChild(e)}}}))}function loadMoreButton(e){let t=document.createElement("button");return t.id="loadMoreButton",t.classList.add("btn","btn-primary"),t.textContent="Load more comments",t.addEventListener("click",(function(){loadComments(startFrom=e.id)})),t}function updateComment(e){let t=document.getElementById(e.id);t.id+="-old";let n=createComment(e);t.before(n),t.remove()}addCommentForm.addEventListener("submit",(function(e){e.preventDefault(),submitComment(this)})),window.onload=loadComments();