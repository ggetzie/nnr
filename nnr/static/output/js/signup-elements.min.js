var stripe,dotter,success_url="/accounts/thankyou/",stripeElements=function(e){var t=(stripe=Stripe(e)).elements().create("card",{style:{base:{fontSize:"16px",color:"#32325d",fontFamily:"-apple-system, BlinkMacSystemFont, Segoe UI, Roboto, sans-serif",fontSmoothing:"antialiased","::placeholder":{color:"rgba(0,0,0,0.4)"}}}});t.mount("#card-element"),t.addEventListener("change",(function(e){var t=document.getElementById("card-errors");e.error?t.textContent=e.error.message:t.textContent=""})),document.getElementById("signup_form").addEventListener("submit",(function(e){e.preventDefault(),clearErrors(),changeLoadingState(!0),createPaymentMethodAndCustomer(t)}))},createPaymentMethodAndCustomer=function(e){var t=document.getElementById("id_email").value;stripe.createPaymentMethod("card",e,{billing_details:{email:t}}).then((function(e){e.error?showCardError(e.error):createCustomer(e.paymentMethod.id,t)}))};async function createCustomer(e){let t=document.getElementById("signup_form"),n={payment_method:e};for(let e=0;e<t.length;e++)"submit"!==t[e].type&&(n[t[e].name]=t[e].value);fetch(t.action,{method:"post",headers:{"Content-Type":"application/json","X-CSRFToken":n.csrfmiddlewaretoken,Accept:"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify(n)}).then((e=>e.json())).then((e=>{"success"===e.status?handleSubscription(e.subscription):(changeLoadingState(!1),handleFormErrors(e.errors))}))}function handleSubscription(e){const{latest_invoice:t,pending_setup_intent:n}=e,{payment_intent:r}=t;let o="Success! Your account has been created. \n                     Please check your email for a confirmation \n                     link to activate your account";if(n){const{client_secret:t,status:n}=e.pending_setup_intent;"requires_action"==n?stripe.confirmCardSetup(t).then((function(e){e.error?showCardError(e.error):(changeLoadingState(!1),document.getElementById("signup_form").reset(),showMessage(o,"alert-success"))})):"requires_payment_method"==n?(changeLoadingState(!1),showCardError("Unable to authorize payment. Please try a different card")):(changeLoadingState(!1),document.getElementById("signup_form").reset(),showMessage(o,"alert-success"))}else changeLoadingState(!1),document.getElementById("signup_form").reset(),showMessage(o,"alert-success")}function getPublicKey(){return fetch("/main/public_key/",{method:"get",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"}}).then((function(e){return e.json()})).then((function(e){stripeElements(e.publicKey)}))}function showCardError(e){changeLoadingState(!1);let t=createAlert(e.message,"alert-danger");document.getElementById("signup_form").before(t)}getPublicKey();var changeLoadingState=function(e){if(console.log("changing loading state"),e){let e=document.getElementById("signup_form"),t=document.createElement("div");t.id="message",t.textContent="Loading",e.before(t),e.hidden=!0,dotter&&clearInterval(dotter),dotter=setInterval((function(){let e=document.getElementById("message");e.textContent=e.textContent+"."}),3e3)}else{clearInterval(dotter),document.getElementById("message").remove(),document.getElementById("signup_form").hidden=!1}};function appendError(e,t){let n=document.getElementById(`id_${e}`),r=document.createElement("div");r.classList.add("invalid-feedback"),r.textContent=t,n.parentElement.appendChild(r)}function handleFormErrors(e){for(fieldName in e){let t=document.getElementById(`id_${fieldName}`);for(i in t.classList.add("is-invalid"),e[fieldName])appendError(fieldName,e[fieldName][i])}}function clearErrors(){let e=document.querySelectorAll(".is-invalid");if(e)for(let t=0;t<e.length;t++)e[t].classList.remove("is-invalid");let t=document.querySelectorAll(".invalid-feedback");if(t)for(let e=0;e<t.length;e++)t[e].remove()}