"use strict";function asyncGeneratorStep(e,t,n,r,o,a,i){try{var s=e[a](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,o)}function _asyncToGenerator(s){return function(){var e=this,i=arguments;return new Promise(function(t,n){var r=s.apply(e,i);function o(e){asyncGeneratorStep(r,t,n,o,a,"next",e)}function a(e){asyncGeneratorStep(r,t,n,o,a,"throw",e)}o(void 0)})}}var stripe,dotter,success_url="/accounts/thankyou/",stripeElements=function(e){var t=(stripe=Stripe(e)).elements().create("card",{style:{base:{fontSize:"16px",color:"#32325d",fontFamily:"-apple-system, BlinkMacSystemFont, Segoe UI, Roboto, sans-serif",fontSmoothing:"antialiased","::placeholder":{color:"rgba(0,0,0,0.4)"}}}});t.mount("#card-element"),t.addEventListener("change",function(e){var t=document.getElementById("card-errors");e.error?t.textContent=e.error.message:t.textContent=""}),document.getElementById("signup_form").addEventListener("submit",function(e){e.preventDefault(),clearErrors(),changeLoadingState(!0),createPaymentMethodAndCustomer(t)})},createPaymentMethodAndCustomer=function(e){var t=document.getElementById("id_email").value;stripe.createPaymentMethod("card",e,{billing_details:{email:t}}).then(function(e){e.error?showCardError(e.error):createCustomer(e.paymentMethod.id,t)})};function createCustomer(e){return _createCustomer.apply(this,arguments)}function _createCustomer(){return(_createCustomer=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var n,r,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:for(n=document.getElementById("signup_form"),r={payment_method:t},o=0;o<n.length;o++)"submit"!==n[o].type&&(r[n[o].name]=n[o].value);fetch(n.action,{method:"post",headers:{"Content-Type":"application/json","X-CSRFToken":r.csrfmiddlewaretoken,Accept:"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify(r)}).then(function(e){return e.json()}).then(function(e){"success"===e.status?handleSubscription(e.subscription):(changeLoadingState(!1),handleFormErrors(e.errors))});case 4:case"end":return e.stop()}},e)}))).apply(this,arguments)}function handleSubscription(e){var t,n,r,o=e.latest_invoice,a=e.pending_setup_intent,i=(o.payment_intent,"Success! Your account has been created. \n                     Please check your email for a confirmation \n                     link to activate your account");a?(n=(t=e.pending_setup_intent).client_secret,"requires_action"==(r=t.status)?stripe.confirmCardSetup(n).then(function(e){e.error?showCardError(e.error):(changeLoadingState(!1),document.getElementById("signup_form").reset(),showMessage(i,"alert-success"))}):"requires_payment_method"==r?(changeLoadingState(!1),showCardError("Unable to authorize payment. Please try a different card")):(changeLoadingState(!1),document.getElementById("signup_form").reset(),showMessage(i,"alert-success"))):(changeLoadingState(!1),document.getElementById("signup_form").reset(),showMessage(i,"alert-success"))}function getPublicKey(){return fetch("/main/public_key/",{method:"get",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"}}).then(function(e){return e.json()}).then(function(e){stripeElements(e.publicKey)})}function showCardError(e){changeLoadingState(!1);var t=createAlert(e.message,"alert-danger");document.getElementById("signup_form").before(t)}getPublicKey();var changeLoadingState=function(e){var t,n;console.log("changing loading state"),e?(t=document.getElementById("signup_form"),(n=document.createElement("div")).id="message",n.textContent="Loading",t.before(n),t.hidden=!0,dotter&&clearInterval(dotter),dotter=setInterval(function(){var e=document.getElementById("message");e.textContent=e.textContent+"."},3e3)):(clearInterval(dotter),document.getElementById("message").remove(),document.getElementById("signup_form").hidden=!1)};function appendError(e,t){var n=document.getElementById("id_".concat(e)),r=document.createElement("div");r.classList.add("invalid-feedback"),r.textContent=t,n.parentElement.appendChild(r)}function handleFormErrors(e){for(fieldName in e){var t=document.getElementById("id_".concat(fieldName));for(i in t.classList.add("is-invalid"),e[fieldName])appendError(fieldName,e[fieldName][i])}}function clearErrors(){var e=document.querySelectorAll(".is-invalid");if(e)for(var t=0;t<e.length;t++)e[t].classList.remove("is-invalid");var n=document.querySelectorAll(".invalid-feedback");if(n)for(var r=0;r<n.length;r++)n[r].remove()}