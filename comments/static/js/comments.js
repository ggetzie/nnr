"use strict";function asyncGeneratorStep(e,t,n,o,a,d,r){try{var i=e[d](r),c=i.value}catch(e){return void n(e)}i.done?t(c):Promise.resolve(c).then(o,a)}function _asyncToGenerator(i){return function(){var e=this,r=arguments;return new Promise(function(t,n){var o=i.apply(e,r);function a(e){asyncGeneratorStep(o,t,n,a,d,"next",e)}function d(e){asyncGeneratorStep(o,t,n,a,d,"throw",e)}a(void 0)})}}var addCommentForm=document.getElementById("addCommentForm");function submitComment(e){return _submitComment.apply(this,arguments)}function _submitComment(){return(_submitComment=_asyncToGenerator(regeneratorRuntime.mark(function e(a){var t;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:t={text:a.text.value,recipe:a.recipe.value,user:a.user.value},fetch(a.action,{method:"post",headers:{"Content-Type":"application/json","X-CSRFToken":a.csrfmiddlewaretoken.value,Accept:"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify(t)}).then(function(e){return e.json()}).then(function(e){var t,n,o;e.error?(t=createErrorDiv(e.error),a.before(t)):(a.text.value="",n=createComment(e.comment),(o=document.getElementById("comment-list")).insertBefore(n,o.children[0]))});case 2:case"end":return e.stop()}},e)}))).apply(this,arguments)}function createErrorDiv(e){return createAlert(e,["alert-danger"])}function createComment(e){var t=document.createElement("div");t.id=e.id,t.classList.add("comment");var n=createCommentHeader(e);n.classList.add("comment-header"),t.appendChild(n);var o=document.createElement("div");o.classList.add("comment-body"),o.innerHTML=e.html,t.appendChild(o);var a=editModal(e);t.appendChild(a);var d=deleteModal(e.id);return t.appendChild(d),t}function createCommentHeader(e){var t,n,o,a,d,r=document.createElement("div");return r.classList.add("text-muted","comment-header"),userSpan=document.createElement("span"),userSpan.textContent=e.user.username,userSpan.classList.add("comment-user"),r.appendChild(userSpan),tsSpan=document.createElement("span"),tsSpan.classList.add("comment-ts"),tsSpan.textContent=e.timestamp,r.appendChild(tsSpan),Number(document.querySelector('meta[name="user_id"]').content)===Number(e.user.id)&&((t=document.createElement("div")).classList.add("dropdown","float-right","comment-control"),dropdownButton=document.createElement("button"),dropdownButton.classList.add("btn","btn-outline-secondary","btn-sm","comment-dropdown"),dropdownButton.setAttribute("type","button"),dropdownButton.innerHTML="&#8901;&#8901;&#8901;",n="".concat(e.id,"-dropdown"),dropdownButton.id=n,dropdownButton.setAttribute("data-toggle","dropdown"),dropdownButton.setAttribute("aria-haspopup","true"),dropdownButton.setAttribute("aria-expanded","false"),t.appendChild(dropdownButton),(o=document.createElement("div")).classList.add("dropdown-menu"),o.setAttribute("aria-labelledby",n),t.appendChild(o),(a=document.createElement("button")).classList.add("dropdown-item"),a.setAttribute("data-toggle","modal"),a.setAttribute("data-target","#edit-".concat(e.id,"-modal")),a.textContent="Edit",o.appendChild(a),(d=document.createElement("button")).classList.add("dropdown-item"),d.setAttribute("data-toggle","modal"),d.setAttribute("data-target","#delete-".concat(e.id,"-modal")),d.textContent="Delete",o.appendChild(d),r.appendChild(t)),r}function editModal(e){var t=document.createElement("form");t.action="/comments/edit/",t.method="post",t.id="edit-".concat(e.id),t.classList.add("comment-form"),t.addEventListener("submit",function(e){e.preventDefault(),editComment(t)});var n=document.createElement("input");n.type="hidden",n.value=e.id,n.name="id",t.appendChild(n);var o=document.createElement("textarea");o.value=e.text,o.classList.add("textarea","form-control"),o.setAttribute("cols",40),o.setAttribute("rows",5),o.setAttribute("required",""),o.name="text";var a=document.createElement("div");a.classList.add("form-group"),a.appendChild(o),t.appendChild(a);var d=document.createElement("button");d.classList.add("btn","btn-secondary"),d.setAttribute("data-dismiss","modal"),d.textContent="Cancel";var r=document.createElement("input");r.type="submit",r.value="Submit",r.classList.add("btn","btn-primary");var i=document.createElement("div");return i.classList.add("form-actions"),i.appendChild(d),i.appendChild(r),t.appendChild(i),modal=Modal("edit-".concat(e.id,"-modal"),"Edit Comment",t),modal}function deleteModal(e){var t=document.createElement("p");t.textContent="Comment will be deleted. Are you sure?";var n=document.createElement("div");n.appendChild(t);var o=document.createElement("form");o.id="delete-".concat(e),o.action="/comments/delete/",o.method="post",o.addEventListener("submit",function(e){e.preventDefault(),deleteComment(o)});var a=document.createElement("input");a.name="id",a.value=e,a.type="hidden",o.appendChild(a);var d=document.createElement("div");d.classList.add("form-actions"),o.appendChild(d);var r=document.createElement("button");r.textContent="No",r.setAttribute("data-dismiss","modal"),r.classList.add("btn","btn-secondary"),d.appendChild(r);var i=document.createElement("input");return i.textContent="Yes",i.type="submit",i.value="Yes",i.classList.add("btn","btn-danger"),d.appendChild(i),n.appendChild(o),Modal("delete-".concat(e,"-modal"),"Delete Comment",n)}function Modal(e,t,n){var o=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null,a=document.createElement("div");a.id=e,a.classList.add("modal"),a.setAttribute("tabindex","-1"),a.setAttribute("role","dialog");var d="".concat(e,"-title");a.setAttribute("aria-labelledby",d),a.setAttribute("aria-hidden","true");var r=document.createElement("div");r.classList.add("modal-dialog","modal-dialog-centered"),r.setAttribute("role","document"),a.appendChild(r);var i=document.createElement("div");i.classList.add("modal-content"),r.appendChild(i);var c=document.createElement("div");c.classList.add("modal-header");var m=document.createElement("h5");m.classList.add("modal-title"),m.textContent=t,c.appendChild(m),c.appendChild(closeModal()),i.appendChild(c);var s,l=document.createElement("div");return l.classList.add("modal-body"),l.appendChild(n),i.appendChild(l),o&&((s=document.createElement("div")).classList.add("modal-footer"),s.appendChild(o),i.appendChild(s)),a}function closeModal(){var e=document.createElement("button");e.setAttribute("type","button"),e.classList.add("close"),e.setAttribute("data-dismiss","modal"),e.setAttribute("aria-label","Close");var t=document.createElement("span");return t.setAttribute("aria-hidden","true"),t.innerHTML="&times;",e.appendChild(t),e}function deleteComment(e){return _deleteComment.apply(this,arguments)}function _deleteComment(){return(_deleteComment=_asyncToGenerator(regeneratorRuntime.mark(function e(o){var a,t;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:a={id:o.id.value},t=document.querySelector('#comment-list input[name="csrfmiddlewaretoken"]').value,fetch(o.action,{method:"post",headers:{"Content-Type":"application/json","X-CSRFToken":t,Accept:"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify(a)}).then(function(e){return e.json()}).then(function(e){var t,n=document.getElementById(a.id);document.querySelector("#delete-".concat(o.id.value,"-modal button.close")).click(),e.error?(ed=createErrorDiv(e.error),n.before(ed)):(t=createAlert("Comment Deleted.",["alert-success"]),n.before(t),n.remove())});case 3:case"end":return e.stop()}},e)}))).apply(this,arguments)}function editComment(e){return _editComment.apply(this,arguments)}function _editComment(){return(_editComment=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var n,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:n={id:t.id.value,text:t.text.value},o=document.querySelector('#comment-list input[name="csrfmiddlewaretoken"]').value,fetch(t.action,{method:"post",headers:{"Content-Type":"application/json","X-CSRFToken":o,Accept:"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify(n)}).then(function(e){return e.json()}).then(function(e){e.error?(ed=createErrorDiv(response.error.message),t.before(ed)):(document.querySelector("#edit-".concat(t.id.value,"-modal button.close")).click(),updateComment(e.comment))});case 3:case"end":return e.stop()}},e)}))).apply(this,arguments)}function loadComments(){return _loadComments.apply(this,arguments)}function _loadComments(){return(_loadComments=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,n,o,a,d=arguments;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:t=0<d.length&&void 0!==d[0]?d[0]:null,n=1<d.length&&void 0!==d[1]?d[1]:25,o=document.querySelector('meta[name="recipe_id"]').content,a="/comments/list/?recipe_id=".concat(o,"&max_comments=").concat(n),t&&(a+="&start_from=".concat(t)),fetch(a,{method:"get",headers:{"Content-Type":"application/json",Accept:"application/json","X-Requested-With":"XMLHttpRequest"}}).then(function(e){return e.json()}).then(function(e){var t=document.getElementById("comment-list"),n=document.getElementById("loadMoreButton");if(n&&n.remove(),e.error){var o=createErrorDiv(response.error);t.appendChild(o)}else for(var a=0;a<e.comment_list.length;a++){var d,r=createComment(e.comment_list[a]);t.appendChild(r),a===e.comment_list.length-1&&e.has_more&&(d=loadMoreButton(r),t.appendChild(d))}});case 6:case"end":return e.stop()}},e)}))).apply(this,arguments)}function loadMoreButton(e){var t=document.createElement("button");return t.id="loadMoreButton",t.classList.add("btn","btn-primary"),t.textContent="Load more comments",t.addEventListener("click",function(){loadComments(startFrom=e.id)}),t}function updateComment(e){var t=document.getElementById(e.id);t.id+="-old";var n=createComment(e);t.before(n),t.remove()}addCommentForm.addEventListener("submit",function(e){e.preventDefault(),submitComment(this)}),window.onload=loadComments();